---
title: 舆图记事本
createTime: 2025/09/02 13:28:01
permalink: /article/apifgy69/
---
## 图例解析

### 历史

元代朱思本 -->《舆地图》

1541+ 明代罗洪先 -->《广舆图》

1718 皇舆全览图

1722 雍正十排图

1787 乾隆内府舆图



### 图例符号确定

**优先级：**

1. 1895年“安徽舆地图”的图例表-》明清两代全国和省区地图集编制概况
2. 明、清地图主要符号对比-》明、清、民国时期地图要素视觉表达方法分析
3. 清代几种地图和地图集所用居民点符号-》试论我国地图的数学要素和表示方法的演进特色
4. 广舆图24种符号-》试论我国地图的数学要素和标志方法的演进特色
5. 中国古代地图的图式符号举例-》中国古代地图绘制的理论和方法初探



- 点特征：山、森林、村镇、州、县、府城、文官驻所；桥、柳条边门、柳条边台；城池、太平府等特殊景观
- 线性特征：河流、驿路、淤河、河岸线、长城
- 面特征：湖泊、沙漠

`来源：康熙《皇舆全览图》的数字化及意义`



### 联系专家

霍仁龙老师：

- **四川大学国际关系学院**网页：https://sis.scu.edu.cn/news.html?newsId=2166
  - 此单位电话：028-85470709
    - 目前情况：已告知，等待回复（1912452912@qq.com / 13653917580）
- **中国人民大学清史研究所**网页：http://iqh.ruc.edu.cn/xwdt/9b3c0b9cdea3453e8c94856de3dce44e.htm
- 百度词条：https://baike.baidu.com/item/%E9%9C%8D%E4%BB%81%E9%BE%99/24690515



韩昭庆老师：

- **中国历史地理研究所**网页：https://yugong.fudan.edu.cn/info/1113/3421.htm
  - 此单位电话：(86)-21-65642714
- 百度词条：https://baike.baidu.com/item/%E9%9F%A9%E6%98%AD%E5%BA%86?fromModule=lemma_search-box



### 河流 湖泊图例类别

> 河流只有一种类别：双实线。不存在单实线树状结构

**存在的其他问题：**

1. 双实线绘制过密的问题【皇舆全览图-32页】

<img src="./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20251024082033942.png" alt="image-20251024082033942" style="zoom: 33%;" />

<img src="./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20251024082259081.png" alt="image-20251024082259081" style="zoom:33%;" />

2. 河流绘制出现断线【皇舆全览图-38页】

![image-20251024082803692](./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20251024082803692.png)

- [ ] 2. 两条边界线评价方面
- [ ] 调研mapsam算法



## 数据集制作

图像预处理：

对大图进行标注

- 保证标签在所有图块的边缘处是**完美对齐**；
- 极大地减少了模型在图块拼接处的预测错误；
- 如果对小图进行标注，会导致训练标签中出现**不连续**的错误）

使用scale_factor=2 搭配 tile_size=512对图像进行缩放和切块。

- 保证图像信息密度
- 保证图像实际大小，防止oom

### sam2unet渐进式标注

1. x-anylabeling：生成mask图像
2. sam2unet：原图+mask图像 拿去训练
3. sam2unet：剩下的图用训练好的模型推理并声称标注文件
4. labelme：修改标注





## 对比实验（多）

mask2former（68已配置）--2022CVPR

deeplabv3+（68已下载）--2018

unet+aspp（对比来源：Leveraging uncertainty estimation and spatial  pyramid pooling for extracting hydrological features from scanned historical topographic  maps）--2022

sam2-unet（68已配置）--2025ICCVW

mapsam（2024）（68已配置）--2025



## 评价指标（多）

| 指标                 | 类型     | 主要用途                           |
| -------------------- | -------- | ---------------------------------- |
| **Dice**             | 区域重叠 | 区分对象整体是否预测正确           |
| **IoU**              | 区域重叠 | 更严格的区域一致性评估             |
| **Boundary-F1**      | 边界     | 容差范围内边界是否对齐             |
| **ASSD**             | 边界距离 | 平均边界偏差（整体准确度）         |
| **HD95**             | 边界距离 | 最大偏差的稳健衡量（错误严重程度） |
| **Chamfer Distance** | 边界距离 | 用于细长结构（河流、道路）         |

## 标题

> 水系特征的“特征”二字与“特征提取”有混淆

### 参考标题

- 清代舆图河湖水系提取方法研究



### 水文要素/水系区域指的是什么？

> 不够确凿

古代地图中的水文要素是地图描绘自然地理与人文水系的核心内容，其呈现形式随制图技术、时代需求和地域文化差异有所变化，但核心类别可归纳为**自然水文要素**和**人文水文要素**两大类，其中清代舆图因测绘技术发展和实用需求，水文要素的描绘更具系统性和细节性，与你研究的 “清代舆图数字化与水文要素分割” 高度相关。

#### 一、自然水文要素

这类要素是对天然水系的直接描绘，是古代地图水文内容的基础，不同朝代的地图会根据认知和精度呈现不同细节：

1. **河流**
   - 主流与支流：是最核心的水文要素，古代地图中常以线条粗细、虚实区分主流（如长江、黄河干流）和支流（如汉江、渭河），清代实测舆图（如《康熙皇舆全览图》）还会标注河流走向、曲直变化及河道宽度。
   - 特殊河段：包括急流、浅滩、瀑布、河曲等，部分古地图会用符号或文字注记（如 “滩”“濑”“瀑”）标识，清代边疆舆图中还会标注季节性河流（时令河）的枯水、丰水状态。
2. **湖泊与沼泽**
   - 湖泊：以闭合曲线表示轮廓，大型湖泊（如太湖、鄱阳湖）会标注名称，清代舆图中还会区分淡水湖和咸水湖（如青海湖注 “咸水”），部分地图会描绘湖泊与河流的连通关系。
   - 沼泽 / 湿地：多以晕染、点状符号或文字（如 “泽”“淀”“淖”）表示，如《平江图》中对江南水乡沼泽的描绘，清代《乾隆内府舆图》则对东北三江平原沼泽有更精准的标识。
3. **海洋与海岸**
   - 海洋：早期古地图多以抽象图形（如波浪纹）或文字（如 “海”“洋”）表示，清代实测海图（如《福建沿海舆图》）会绘制海岸线轮廓、海湾、半岛、海岛，还标注潮汐规律（如 “潮涨时”“潮落处”）。
   - 河口：重点描绘河流入海口的形态（如三角洲、喇叭口），清代舆图中会标注河口泥沙淤积、沙洲分布等细节。
4. **泉与井**
   - 泉：多见于区域地图或城镇图，以符号（如圆形、水滴形）加文字注记（如 “温泉”“冷泉”）表示，是内陆干旱地区地图的重要水文要素。
   - 井：在北方缺水地区或城镇地图中常见，以小圆圈或 “井” 字符号标识，部分古地图会标注井的深度、水质（如 “甜水井”“苦水井”）。

#### 二、人文水文要素

这类要素是人类利用、改造水系的产物，体现了水文与社会经济、军事防御的结合，清代舆图中此类要素的描绘尤为丰富：

1. **水利工程**
   - 运河与渠：人工开凿的水运通道，如京杭大运河在明清地图中以粗线标注，还会标注运河上的闸、坝、堰（如 “通惠河闸”“高家堰”），清代《运河图》详细绘制了运河的水闸分布、通航能力。
   - 堤坝与圩垸：防洪、灌溉设施，以线条或阴影表示堤坝轮廓，标注 “堤”“圩”“垸” 等文字，如清代江南舆图中对太湖圩田堤坝的描绘。
   - 水库与陂塘：人工蓄水设施，小型陂塘以闭合曲线加注记（如 “塘”“陂”）表示，大型水库（如浙江的东钱湖）在清代舆图中会标注蓄水量、灌溉范围。
2. **水运设施**
   - 渡口与码头：以符号（如船形、方形）加文字（如 “渡”“津”）表示，清代漕运图中会标注渡口的规模（如 “大渡”“小渡”）、通航船舶类型。
   - 桥梁：跨越河流的交通设施，以象形符号（如拱形、梁形）表示，清代舆图中会区分石桥、木桥、浮桥，还标注桥梁的长度、宽度及通行能力。
   - 船闸与漕运码头：运河专用设施，清代《京杭运河全图》中会详细绘制船闸的结构、启闭方式，以及漕运码头的仓储、装卸区域。
3. **水文管理与标识**
   - 水文站 / 水尺：清代后期近代测绘技术传入后，部分舆图会标注水位观测点（水尺）的位置，记录汛期、枯水期水位，是水文监测的早期形式。
   - 防汛与水利管理机构：如 “河督署”“堤工局” 等，在清代黄河、长江流域舆图中会标注此类机构的位置，体现对水文治理的行政管控。

#### 三、古代水文要素的表示特点

1. **符号化与文字注记结合**：早期古地图以文字注记为主，符号为辅；宋代以后（如《华夷图》《禹迹图》）逐渐形成固定的水文符号体系，清代则结合实测数据，符号更具规范性。
2. **实用性优先**：军事、漕运、水利类地图的水文要素更详细，如军事舆图会重点标注河流的通航、渡河条件，漕运图则聚焦运河的水利设施。
3. **精度随技术发展提升**：清代西洋测绘技术传入后，水文要素的位置、轮廓更接近实际，河流走向、湖泊面积的绘制误差大幅减小。





## 创新点

### 地图质量：断线、污损、受排线干扰

#### 模型改进

- 使用“长距离注意力”
- 使用形态学方法进行骨架增强

#### 损失函数改进

在 Loss 中融入“轮廓连续性”

可以使用：

- **Boundary Loss**
- **Hausdorff Loss**
- **Connectivity Loss（论文 CVPR2022）**

这些 loss 会强制预测 mask 更连续，减少断裂。



####  MorSP 改进（网络设计和训练策略）：

> 用于提升图像中图形的主干信息，减少断裂干扰

##### 1. **引入拓扑或骨架先验到损失函数**

MorSP 当前在 `energy` 函数里直接比较 `get_skelton(w)` 和 `get_skelton(v)`。可以增强骨架连续性和主干优先级：

```
def energy(self, w, v):
    skel_pred = self.get_skelton(w)
    skel_gt   = self.get_skelton(v)
    
    # 1. 骨架匹配损失
    loss_skel = torch.norm(skel_pred - skel_gt)

    # 2. 连通性约束（简化）
    # 计算骨架图的连通分支数差异
    conn_diff = torch.abs(num_connected_components(skel_pred) - num_connected_components(skel_gt))

    # 3. 主干优先约束（距离场加权）
    dist_gt = distance_transform(skel_gt) # 可用 Euclidean Distance Transform
    loss_main = torch.sum((dist_gt * skel_pred) ** 2)

    return loss_skel + 0.1*conn_diff + 0.5*loss_main
```

- **作用**：
  - `conn_diff` 保持骨架拓扑结构（减少断裂分支）。
  - `loss_main` 强调骨架主干（距离场中心线优先）。

> 注意：`num_connected_components` 和 `distance_transform` 可以用 PyTorch 或 CPU/Numpy 先处理成张量形式。

------

##### 2. **骨架多尺度融合**

- 在 `SmoothSkeleton` 中增加 **多尺度卷积核**：
  - 小核捕捉细枝，大核捕捉主干。
  - 融合多尺度骨架输出，过滤噪声断裂。

```
skel_small = SmoothSkeleton(half_size=1)(x)
skel_mid   = SmoothSkeleton(half_size=2)(x)
skel_large = SmoothSkeleton(half_size=3)(x)

skel_final = (skel_small + skel_mid + skel_large) / 3
```

- 优势：对不同宽度的骨干和小分支都有响应，同时减少断裂敏感性。

------

##### 3. **距离场增强骨架**

- 在模型前向前增加 **距离场通道**：
  - 输入不仅是原始预测 `o`，还加入目标距离场 `dist_map`。
  - 例如：

```
o_input = torch.cat([o, dist_map], dim=1)
```

- 训练时，骨架损失优先靠近距离场中心线：
  - 能自动偏向主干，弱化小断裂和噪声。

------

##### 4. **图论/最短路径后处理可微化**

- 将骨架像素视为图节点，断裂处用最短路径连接：
  - 可以实现 **可微化近似**：
    - 用 soft adjacency 或 differentiable shortest-path (softmax-weighted adjacency)。
  - 在训练中可直接优化骨架连通性。

> 这样即使输入预测有小断裂，模型也会学习将骨架连成完整主干。

------

##### 5. **训练策略改进**

1. **骨架增强数据**：
   - 对训练图像人为制造小断裂。
   - 保留骨架 ground truth，模型学习跨越断裂。
2. **迭代优化**：
   - MorSP 本身是迭代 ADMM 优化，可在每次迭代中引入骨架主干优先约束。
3. **边界-骨架联合训练**：
   - 预测骨架和边界双通道输出。
   - 边界连续性辅助骨架填补断裂。

------

💡 **总结改进思路**

- **损失函数层面**：骨架匹配 + 连通性 + 距离场主干权重
- **模型输入层面**：加入距离场或边界信息
- **骨架提取模块**：多尺度 SmoothSkeleton 或 Soft-Graph 融合
- **后处理可微化**：最短路径 / 图论增强骨架连通性





#### 现状：

断线：

<img src="./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20250903121330831.png" alt="image-20250903121330831" style="zoom:50%;" />

污损：

<img src="./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20250903124245102.png" alt="image-20250903124245102" style="zoom: 33%;" />

受排线干扰：

![image-20250903122800118](./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20250903122800118.png)

### 创新点2

模型对细长条目标的鲁棒性不佳，难以完整分割



## 细分问题

### 河流：分割

1. **模型对细长条目标的鲁棒性不佳，难以完整分割**
3. 如何判断是否是湖海？人肉眼可以根据旁边的边界物，比如山脉，模型呢？
4. 河道偏移【十排页面14】

<img src="./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20251126142940631.png" alt="image-20251126142940631" style="zoom:67%;" />

1. 河流与湖泊分类在模型上效果不准确，可找方法改善（湖泊依赖大尺度、河流依赖小尺度。湖泊在较窄部分被错认为河流）。
   - 来源：Leveraging uncertainty estimation and spatial pyramid pooling for extracting hydrological features from scanned historical topographic maps

<img src="./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20250903115113449.png" alt="image-20250903115113449" style="zoom: 67%;" />

<img src="./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20250903115812317.png" alt="image-20250903115812317" style="zoom:33%;" />

<img src="./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20250903122430262.png" alt="image-20250903122430262" style="zoom:50%;" />

<img src="./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20250903123116059.png" alt="image-20250903123116059" style="zoom:50%;" />

<img src="./%E8%88%86%E5%9B%BE%E8%AE%B0%E4%BA%8B%E6%9C%AC.assets/image-20250903123215896.png" alt="image-20250903123215896" style="zoom:50%;" />



## 名句

当车辆进入具有严重遮挡和极端光照条件的场景时，信息不足会导致检测结果不佳。这个问题被称为==无视觉线索==，是车道线检测中遇到的另一个问题。在这种情况下，迫切需要更高层次的语义分割车道线。



## 任务
